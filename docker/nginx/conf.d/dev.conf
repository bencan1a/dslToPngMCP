# =============================================================================
# Nginx Development Configuration
# =============================================================================
# Development-specific configuration with debugging enabled
# and relaxed security settings for local development
# =============================================================================

# =============================================================================
# Main Server Block - HTTP
# =============================================================================
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    
    server_name localhost *.localhost;
    
    # Enable detailed error logging for development
    error_log /var/log/nginx/error.log debug;
    access_log /var/log/nginx/access.log detailed;
    
    # Root directory for static files
    root /var/www/html;
    index index.html index.htm;
    
    # ==========================================================================
    # Security Headers (Relaxed for Development)
    # ==========================================================================
    add_header X-Debug-Mode "development" always;
    add_header X-Request-ID $request_id always;
    
    # ==========================================================================
    # Health Check Endpoint
    # ==========================================================================
    location /health {
        access_log off;
        return 200 'healthy\n';
        add_header Content-Type text/plain;
        add_header X-Health-Check "nginx-ok";
    }
    
    # ==========================================================================
    # API Endpoints - Proxy to FastAPI Backend
    # ==========================================================================
    location /api/ {
        # Rate limiting (generous for development)
        limit_req zone=api burst=20 nodelay;
        
        # Proxy configuration
        proxy_pass http://fastapi_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        
        # Timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        
        # Cache bypass for development
        proxy_cache_bypass 1;
        proxy_no_cache 1;
    }
    
    # Root API endpoints (without /api prefix)
    location ~ ^/(health|docs|redoc|openapi\.json)$ {
        limit_req zone=api burst=10 nodelay;
        
        proxy_pass http://fastapi_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        
        # No cache for development
        proxy_cache_bypass 1;
        proxy_no_cache 1;
    }
    
    # DSL processing endpoints
    location ~ ^/(render|validate|status)($|/) {
        limit_req zone=render burst=10 nodelay;
        
        proxy_pass http://fastapi_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        
        # Extended timeouts for rendering
        proxy_connect_timeout 10s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        
        # Large body size for DSL content
        client_max_body_size 10m;
        
        # No cache for development
        proxy_cache_bypass 1;
        proxy_no_cache 1;
    }
    
    # Task management endpoints
    location ~ ^/(tasks/)(.*)$ {
        limit_req zone=api burst=15 nodelay;
        
        proxy_pass http://fastapi_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        
        # No cache for development
        proxy_cache_bypass 1;
        proxy_no_cache 1;
    }
    
    # ==========================================================================
    # Static File Serving - PNG Results
    # ==========================================================================
    location /static/png/ {
        alias /var/www/static/png/;
        
        # Rate limiting for static files
        limit_req zone=static burst=50 nodelay;
        
        # Cache control for development (short cache)
        expires 5m;
        add_header Cache-Control "public, no-transform";
        add_header X-Static-File "png";
        
        # Security headers for images
        add_header X-Content-Type-Options nosniff;
        
        # Try to serve file, fallback to 404
        try_files $uri =404;
        
        # MIME type for PNG files
        location ~* \.png$ {
            add_header Content-Type image/png;
        }
    }
    
    # ==========================================================================
    # MCP Server Proxy (for development debugging)
    # ==========================================================================
    location /mcp/ {
        # Development only - remove in production
        limit_req zone=api burst=10 nodelay;
        
        proxy_pass http://mcp_backend/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        
        # No cache for development
        proxy_cache_bypass 1;
        proxy_no_cache 1;
    }
    
    # ==========================================================================
    # Development Tools and Monitoring
    # ==========================================================================
    location /nginx-status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow 172.0.0.0/8;  # Docker networks
        deny all;
    }
    
    # Development metrics endpoint
    location /metrics {
        # Prometheus metrics (if enabled)
        proxy_pass http://fastapi_backend/metrics;
        proxy_set_header Host $host;
        allow 127.0.0.1;
        allow 172.0.0.0/8;  # Docker networks
        deny all;
    }
    
    # ==========================================================================
    # Default Static Content
    # ==========================================================================
    location / {
        try_files $uri $uri/ /index.html;
        
        # Cache control for static assets
        location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg)$ {
            expires 1h;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # ==========================================================================
    # Error Pages
    # ==========================================================================
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    location = /404.html {
        root /var/www/html;
        internal;
    }
    
    location = /50x.html {
        root /var/www/html;
        internal;
    }
}

# =============================================================================
# HTTPS Server Block (Self-signed for development)
# =============================================================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    
    server_name localhost *.localhost;
    
    # Self-signed certificate for development
    ssl_certificate /etc/nginx/ssl/dev-cert.pem;
    ssl_certificate_key /etc/nginx/ssl/dev-key.pem;
    
    # Relaxed SSL settings for development
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # Same location blocks as HTTP server (included inline above)
    # Note: Location blocks are already defined in the HTTP server block above
    
    # ==========================================================================
    # Health Check Endpoint
    # ==========================================================================
    location /health {
        access_log off;
        return 200 'healthy\n';
        add_header Content-Type text/plain;
        add_header X-Health-Check "nginx-ok";
    }
    
    # Root API endpoints (without /api prefix)
    location ~ ^/(health|docs|redoc|openapi\.json)$ {
        limit_req zone=api burst=10 nodelay;
        
        proxy_pass http://fastapi_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        
        # No cache for development
        proxy_cache_bypass 1;
        proxy_no_cache 1;
    }
    
    # API Endpoints - Proxy to FastAPI Backend
    location /api/ {
        limit_req zone=api burst=20 nodelay;
        
        proxy_pass http://fastapi_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
        
        proxy_cache_bypass 1;
        proxy_no_cache 1;
    }
}